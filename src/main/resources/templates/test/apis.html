<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>API TEST</title>

	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
	<link id="contextPathHolder" th:data-contextPath="${#httpServletRequest.getContextPath()}" />

	<style>
		select {
			/* width: 80%; */
		}

		textarea.httpHeader {
			width: 100%;
			height: 3rem;
			resize: none;
		}

		textarea.httpBody {
			width: 100%;
			height: 20rem;
			resize: none;
		}
	</style>

	<script type="text/javascript" th:src="@{/js/axios.min.js}"></script>
	<script type="text/javascript">

		const nJsonStringifySpace = 5;

		document.addEventListener('DOMContentLoaded', (event) => {
			const sApiAuthKey = document.querySelector('#apiAuthKey').value;
			const sContextPath = document.querySelector('#contextPathHolder').getAttribute('data-contextPath');
			const sLocation = location.toString();
			const nIndex = sLocation.indexOf(sContextPath);
			const sBaseUrl = sLocation.substr(0, (nIndex + sContextPath.length));

			const oHttpRequestHeader = {
				'X-API-Key': sApiAuthKey,
				'Content-Type': 'application/json'
			}

			document.querySelector('#apiPath').addEventListener('change', async (event) => {
				document.querySelector('#requestHeader').value = '';
				document.querySelector('#requestBody').value = '';
				document.querySelector('#responseBody').value = '';

				if (event.target.value === '') {
					document.querySelector('#btnForRequest').disabled = true;
					return;
				} else {
					document.querySelector('#btnForRequest').disabled = false;
				}

				const sParamNameForRequestMockData = document.querySelector('#paramNameForRequestMockData').value;
				const sUrlForRequestMockData = document.querySelector('#urlForRequestMockData').value;

				const sUrl = sBaseUrl + sUrlForRequestMockData;


				const res = await axios({
					url: sUrl,
					method: 'GET',
					headers: {
						// 'X-API-Key': sApiAuthKey
					},
					params: {
						[sParamNameForRequestMockData]: event.target.value
					},
					responseType: 'json'
				});

				console.log('response for [API-REQUEST]', res);

				const resJson = JSON.stringify(res.data, null, 5);

				document.querySelector('#requestBody').value = resJson;
				document.querySelector('#requestHeader').value = JSON.stringify(oHttpRequestHeader, null, nJsonStringifySpace);
			});


			document.querySelector('#btnForRequest').addEventListener('click', async (event) => {
				event.preventDefault();
				const apiPath = document.querySelector('#apiPath').value;
				const sUrl = sBaseUrl + apiPath;

				const requestHeader = JSON.parse(document.querySelector('#requestHeader').value);
				const requestBody = document.querySelector('#requestBody').value;
				// const oParam = JSON.parse(requestBody);

				const res = await axios({
					url: sUrl,
					method: 'POST',
					headers: requestHeader,
					data: requestBody,
					responseType: 'json'
				});

				console.log('response for [API-RESPONSE]', res);

				const resJson = JSON.stringify(res.data, null, nJsonStringifySpace);

				document.querySelector('#responseBody').value = resJson;
			});

		});


	</script>
</head>

<body>
	<header>
		<h1>API TEST</h1>
	</header>
	<main>
		<form action="">
			<input type="hidden" name="urlForRequestMockData" id="urlForRequestMockData"
				th:value="${urlForRequestMockData}">
			<input type="hidden" name="paramNameForRequestMockData" id="paramNameForRequestMockData"
				th:value="${paramNameForRequestMockData}">
			<input type="hidden" name="apiAuthKey" id="apiAuthKey" th:value="${apiAuthKey}">


			<fieldset>
				<legend>API-IO</legend>
				<div>
					<label for="apiPath">apiPath</label>
					<select name="apiPath" id="apiPath">
						<option value="">&lt;선택&gt;</option>
						<option th:each="apiInfo : ${apiInfoList}" th:value="${apiInfo.path}" th:text="${apiInfo.name}">
						</option>
					</select>
				</div>
			</fieldset>
			<br>
			<fieldset>
				<legend>API-AUTH</legend>
				<div>
					<label for="apiAuthEnabled">apiAuthEnabled</label>
					<input type="text" name="apiAuthEnabled" id="apiAuthEnabled" th:value="${apiAuthEnabled}"
						disabled="disabled">
				</div>
			</fieldset>
			<br>
			<fieldset>
				<legend>API-REQUEST</legend>
				<div>
					<label for="requestHeader">requestHeader</label>
					<textarea name="requestHeader" id="requestHeader" class="httpHeader"></textarea>
				</div>
				<div>
					<label for="requestBody">requestBody</label>
					<textarea name="requestBody" id="requestBody" class="httpBody"></textarea>
				</div>
				<div>
					<button id="btnForRequest" disabled="disabled">요청</button>
				</div>
			</fieldset>
			<br>
			<fieldset>
				<legend>API-RESPONSE</legend>
				<div>
					<label for="responseBody">responseBody</label>
					<textarea name="responseBody" id="responseBody" class="httpBody"></textarea>
				</div>
			</fieldset>
		</form>
	</main>

</body>

</html>